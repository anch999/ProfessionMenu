name: Release WoW Addon

on:
  push:
    tags:
      - "*.*.*" # Trigger on tags like v1.2.3

env:
  ADDON_NAME: ProfessionMenu
  ZIP_FILE_NAME: ProfessionMenu

jobs:
  release:
    name: Create Release if New Version
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # Fetch tags to get the message and commit history
        with:
          fetch-depth: 0 

      - name: Get Commit Log for Release Notes âœ¨
        id: get_release_notes
        run: |
          CURRENT_TAG="${{ github.ref_name }}"
          echo "Current Tag: $CURRENT_TAG"

          # 1. Find all tags, sort them by commit date, and get the second-to-last one.
          # The -v and head -n 2 removes the first line (the current tag).
          PREVIOUS_TAG=$(git tag --sort=-committerdate | grep -E '^([0-9]+\.){2}[0-9]+$' | head -n 2 | tail -n 1)
          
          # 2. Set fallback for the very first release
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "âš ï¸ No previous tag found. Using the initial commit hash."
            # Use a tag-like starting point for logging all commits
            PREVIOUS_TAG="$(git rev-list --max-parents=0 HEAD)" 
          fi
          echo "Previous Tag: $PREVIOUS_TAG"

          # 3. Get the annotated tag message (optional, can be empty)
          TAG_MESSAGE=$(git tag -n99 --format="%(contents)" "$CURRENT_TAG" 2>/dev/null | head -n 1)

          # 4. Generate the commit log between the two tags
          COMMIT_LOG=$(git log "$PREVIOUS_TAG".."$CURRENT_TAG" \
            --no-merges \
            --pretty=format:"* **%s** (`%h`) - @%an")

          # 5. Assemble the final release body
          {
            echo "$TAG_MESSAGE"
            echo ""
            echo "---"
            echo "### ðŸ“ Changes Since $PREVIOUS_TAG"
            echo ""
            echo "$COMMIT_LOG"
          } > RELEASE_BODY.md
          
          echo "release_body_file=RELEASE_BODY.md" >> "$GITHUB_OUTPUT"
          echo "âœ… Generated RELEASE_BODY.md with commit log from $PREVIOUS_TAG"


      - name: Prepare release zip
        id: prepare_zip
        run: |
          version="${{ github.ref_name }}"
          
          zip_name="${{ env.ZIP_FILE_NAME }}-${{ github.event_name == 'push' && 'v' || '' }}${version}.zip"
          echo "Preparing zip for $ADDON_NAME -> $zip_name"
          
          # Use rsync to copy only the necessary addon folders
          rsync -av --exclude='.git' --exclude='.github' --exclude='*.zip' \
            ProfessionMenu \
            "./temp_build/"
          
          # Navigate into the temporary build directory to zip the addon folder
          cd ./temp_build
          zip -r "../${zip_name}" .
          cd ..
          
          # Set the variables as outputs
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "zip_name=${zip_name}" >> "$GITHUB_OUTPUT"
          echo "âœ… Created ${zip_name}"

      - name: Create GitHub Release and Upload Zip
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.prepare_zip.outputs.version }}
          name: ${{ env.ADDON_NAME }} ${{ steps.prepare_zip.outputs.version }}
          files: |
            ${{ steps.prepare_zip.outputs.zip_name }}
          # Use the file created by the previous step as the release body
          body_path: ${{ steps.get_release_notes.outputs.release_body_file }}